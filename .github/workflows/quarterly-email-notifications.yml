name: ğŸ“§ Quarterly Email Notifications

on:
  # ë§¤ ë¶„ê¸° 1ì£¼ì¼ ì „ ìë™ ì‹¤í–‰
  schedule:
    # Q1: 12ì›” ë§ˆì§€ë§‰ ì£¼ (12ì›” 25ì¼) - 1ì›” 1ì¼ 1ì£¼ì¼ ì „
    - cron: '0 9 25 12 *'  # 12ì›” 25ì¼ ì˜¤ì „ 9ì‹œ (UTC)
    # Q2: 3ì›” ë§ˆì§€ë§‰ ì£¼ (3ì›” 25ì¼) - 4ì›” 1ì¼ 1ì£¼ì¼ ì „  
    - cron: '0 9 25 3 *'   # 3ì›” 25ì¼ ì˜¤ì „ 9ì‹œ (UTC)
    # Q3: 6ì›” ë§ˆì§€ë§‰ ì£¼ (6ì›” 25ì¼) - 7ì›” 1ì¼ 1ì£¼ì¼ ì „
    - cron: '0 9 25 6 *'   # 6ì›” 25ì¼ ì˜¤ì „ 9ì‹œ (UTC)
    # Q4: 9ì›” ë§ˆì§€ë§‰ ì£¼ (9ì›” 25ì¼) - 10ì›” 1ì¼ 1ì£¼ì¼ ì „
    - cron: '0 9 25 9 *'   # 9ì›” 25ì¼ ì˜¤ì „ 9ì‹œ (UTC)
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      quarter:
        description: 'ë°œì†¡í•  ë¶„ê¸° (Q1, Q2, Q3, Q4)'
        required: true
        default: 'Q1'
        type: choice
        options:
        - Q1
        - Q2
        - Q3
        - Q4
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: false
        type: boolean

jobs:
  send-quarterly-emails:
    runs-on: ubuntu-latest
    name: ğŸ“§ ë¶„ê¸°ë³„ ë²•ë ¹ ì•Œë¦¼ ë°œì†¡
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“… Determine Quarter
      id: quarter
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "quarter=${{ github.event.inputs.quarter }}" >> $GITHUB_OUTPUT
          echo "test_mode=${{ github.event.inputs.test_mode }}" >> $GITHUB_OUTPUT
        else
          # í˜„ì¬ ë‚ ì§œë¡œ ë¶„ê¸° ê²°ì •
          month=$(date +%m)
          case $month in
            12) echo "quarter=Q1" >> $GITHUB_OUTPUT ;;  # 12ì›” -> Q1 ì•Œë¦¼
            03) echo "quarter=Q2" >> $GITHUB_OUTPUT ;;  # 3ì›” -> Q2 ì•Œë¦¼  
            06) echo "quarter=Q3" >> $GITHUB_OUTPUT ;;  # 6ì›” -> Q3 ì•Œë¦¼
            09) echo "quarter=Q4" >> $GITHUB_OUTPUT ;;  # 9ì›” -> Q4 ì•Œë¦¼
            *) echo "quarter=Q1" >> $GITHUB_OUTPUT ;;   # ê¸°ë³¸ê°’
          esac
          echo "test_mode=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm init -y
        npm install @emailjs/nodejs
        
    - name: ğŸ“§ Send Email Notifications
      env:
        EMAILJS_PUBLIC_KEY: ${{ secrets.EMAILJS_PUBLIC_KEY }}
        EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
        EMAILJS_TEMPLATE_ID: ${{ secrets.EMAILJS_TEMPLATE_ID }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
      run: |
        node - << 'EOF'
        const emailjs = require('@emailjs/nodejs');
        
        // EmailJS ì´ˆê¸°í™”
        emailjs.init({
          publicKey: process.env.EMAILJS_PUBLIC_KEY,
          privateKey: process.env.EMAILJS_PRIVATE_KEY
        });
        
        // í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì • ì½ê¸°
        const quarter = '${{ steps.quarter.outputs.quarter }}';
        const testMode = '${{ steps.quarter.outputs.test_mode }}' === 'true';
        const recipients = process.env.EMAIL_RECIPIENTS.split(',').map(e => e.trim());
        
        console.log(`ğŸ“§ ${quarter} ë¶„ê¸° ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì‹œì‘`);
        console.log(`ğŸ¯ ìˆ˜ì‹ ì ìˆ˜: ${recipients.length}ëª…`);
        console.log(`ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${testMode}`);
        
        // ë¶„ê¸°ë³„ ê¸°ê°„ ì •ë³´
        const quarterPeriods = {
          'Q1': '1ë¶„ê¸° (1ì›”~3ì›”)',
          'Q2': '2ë¶„ê¸° (4ì›”~6ì›”)', 
          'Q3': '3ë¶„ê¸° (7ì›”~9ì›”)',
          'Q4': '4ë¶„ê¸° (10ì›”~12ì›”)'
        };
        
        // ìƒ˜í”Œ ë²•ë ¹ ë°ì´í„° (ì‹¤ì œë¡œëŠ” GitHubì—ì„œ íŒŒì¼ì„ ì½ì–´ì™€ì•¼ í•¨)
        const sampleLaws = [
          'ê°œì¸ì •ë³´ë³´í˜¸ë²• ì‹œí–‰ë ¹ ê°œì •',
          'ê·¼ë¡œê¸°ì¤€ë²• ì‹œí–‰ê·œì¹™ ê°œì •', 
          'ì‚°ì—…ì•ˆì „ë³´ê±´ë²• ê°œì •',
          'ì „ììƒê±°ë˜ë²• ì‹œí–‰ë ¹ ê°œì •',
          'ê³µì •ê±°ë˜ë²• ì‹œí–‰ë ¹ ê°œì •'
        ];
        
        const lawList = sampleLaws.map(law => `â€¢ ${law}`).join('\\n');
        
        // ê° ìˆ˜ì‹ ìì—ê²Œ ì´ë©”ì¼ ë°œì†¡
        async function sendEmails() {
          for (const recipient of recipients) {
            try {
              const templateParams = {
                to_name: 'ë‹´ë‹¹ìë‹˜',
                to_email: recipient,
                from_name: 'LAW WATCH ì‹œìŠ¤í…œ',
                subject: `[LAW WATCH] ${testMode ? quarter + ' (í…ŒìŠ¤íŠ¸)' : quarter} ë²•ë ¹ ê°œì • ì•Œë¦¼`,
                quarter_info: testMode ? quarter + ' (í…ŒìŠ¤íŠ¸)' : quarter,
                quarter_period: quarterPeriods[quarter],
                law_count: sampleLaws.length.toString(),
                law_list: lawList,
                website_url: 'https://tjdudfhr.github.io/law-watch/',
                current_date: new Date().toLocaleDateString('ko-KR'),
                system_name: 'LAW WATCH AI ë²•ê·œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ',
                message: `ì•ˆë…•í•˜ì„¸ìš”, LAW WATCH ì‹œìŠ¤í…œì…ë‹ˆë‹¤.\\n\\n${quarter} ë¶„ê¸° ì‹œí–‰ ì˜ˆì • ë²•ë ¹ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.\\n\\nì´ ${sampleLaws.length}ê±´ì˜ ë²•ë ¹ì´ ì‹œí–‰ë  ì˜ˆì •ì´ë‹ˆ, ì‚¬ì „ ê²€í†  ë° ëŒ€ì‘ ë°©ì•ˆì„ ìˆ˜ë¦½í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`,
                html_content: `
                  <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
                      <h1 style="margin: 0; font-size: 24px;">LAW WATCH</h1>
                      <p style="margin: 10px 0 0 0; opacity: 0.9;">AI ë²•ê·œ ê°œì • ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</p>
                    </div>
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                      <h2 style="color: #333; margin-top: 0;">${quarter} ë¶„ê¸° ë²•ë ¹ ê°œì • ì•Œë¦¼</h2>
                      <p style="color: #666; line-height: 1.6;">ì•ˆë…•í•˜ì„¸ìš”, <strong>LAW WATCH ì‹œìŠ¤í…œ</strong>ì…ë‹ˆë‹¤.</p>
                      <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h3 style="margin-top: 0; color: #333;">ğŸ“Š ì‹œí–‰ ì˜ˆì • ë²•ë ¹: ${sampleLaws.length}ê±´</h3>
                        <div style="color: #555; line-height: 1.8;">${lawList.replace(/\\n/g, '<br>')}</div>
                      </div>
                      <div style="text-align: center; margin: 20px 0;">
                        <a href="https://tjdudfhr.github.io/law-watch/" style="background: #667eea; color: white; padding: 12px 25px; border-radius: 6px; text-decoration: none; font-weight: bold;">ğŸ“‹ LAW WATCH ë°”ë¡œê°€ê¸°</a>
                      </div>
                    </div>
                    <div style="text-align: center; font-size: 12px; color: #999;">
                      <p>ì´ ë©”ì¼ì€ LAW WATCH ì‹œìŠ¤í…œì—ì„œ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                      <p>ë°œì†¡ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}</p>
                    </div>
                  </div>
                `
              };
              
              console.log(`ğŸ“¤ ${recipient}ì—ê²Œ ì´ë©”ì¼ ë°œì†¡ ì¤‘...`);
              
              const result = await emailjs.send(
                process.env.EMAILJS_SERVICE_ID,
                process.env.EMAILJS_TEMPLATE_ID,
                templateParams
              );
              
              console.log(`âœ… ${recipient} ë°œì†¡ ì™„ë£Œ:`, result.status);
              
              // ë°œì†¡ ê°„ê²© (Rate Limiting)
              await new Promise(resolve => setTimeout(resolve, 2000));
              
            } catch (error) {
              console.error(`âŒ ${recipient} ë°œì†¡ ì‹¤íŒ¨:`, error);
            }
          }
        }
        
        sendEmails().then(() => {
          console.log('ğŸ‰ ëª¨ë“  ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ!');
        }).catch(console.error);
        
        EOF
        
    - name: ğŸ“Š Summary Report
      run: |
        echo "## ğŸ“§ ë¶„ê¸°ë³„ ë²•ë ¹ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¶„ê¸°**: ${{ steps.quarter.outputs.quarter }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë°œì†¡ ì¼ì‹œ**: $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
        echo "- **í…ŒìŠ¤íŠ¸ ëª¨ë“œ**: ${{ steps.quarter.outputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹œìŠ¤í…œ**: LAW WATCH AI ë²•ê·œ ëª¨ë‹ˆí„°ë§" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ìë™ ì´ë©”ì¼ ë°œì†¡ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY