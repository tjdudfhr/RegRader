name: Quarterly Email Notification
# ë¶„ê¸°ë³„ ë²•ë ¹ í˜„í™© ìë™ ì´ë©”ì¼ ë°œì†¡

on:
  schedule:
    # ë§¤ ë¶„ê¸° ì‹œì‘ ì¼ì£¼ì¼ ì „ ì˜¤ì „ 9ì‹œ (í•œêµ­ ì‹œê°„)
    # Cronì€ UTC ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ì‹œê°„ -9ì‹œê°„
    - cron: '0 0 25 2,5,8,11 *'  # 3ì›”, 6ì›”, 9ì›”, 12ì›” 25ì¼ ì˜¤ì „ 9ì‹œ (KST)
    - cron: '0 0 18 11 *'         # 12ì›” 18ì¼ (íŠ¹ë³„íˆ 1ë¶„ê¸°ëŠ” ì¼ì£¼ì¼ ë” ì¼ì°)
  
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      email:
        description: 'ë°›ì„ ì´ë©”ì¼ ì£¼ì†Œ'
        required: true
        default: 'test@example.com'
      quarter:
        description: 'ë¶„ê¸° ì„ íƒ'
        required: true
        type: choice
        options:
          - '1ë¶„ê¸°'
          - '2ë¶„ê¸°'
          - '3ë¶„ê¸°'
          - '4ë¶„ê¸°'
          - 'ì „ì²´'

jobs:
  send-quarterly-email:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm install @emailjs/nodejs
        npm install node-fetch
    
    - name: Determine Quarter
      id: quarter
      run: |
        MONTH=$(date +%m)
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          QUARTER="${{ github.event.inputs.quarter }}"
        elif [ $MONTH -eq 12 ] || [ $MONTH -eq 11 ]; then
          QUARTER="1ë¶„ê¸°"
          QUARTER_MONTHS="1,2,3"
        elif [ $MONTH -eq 3 ]; then
          QUARTER="2ë¶„ê¸°"
          QUARTER_MONTHS="4,5,6"
        elif [ $MONTH -eq 6 ]; then
          QUARTER="3ë¶„ê¸°"
          QUARTER_MONTHS="7,8,9"
        elif [ $MONTH -eq 9 ]; then
          QUARTER="4ë¶„ê¸°"
          QUARTER_MONTHS="10,11,12"
        fi
        echo "quarter=$QUARTER" >> $GITHUB_OUTPUT
        echo "months=$QUARTER_MONTHS" >> $GITHUB_OUTPUT
    
    - name: Send Email via EmailJS
      env:
        EMAILJS_PUBLIC_KEY: ${{ secrets.EMAILJS_PUBLIC_KEY }}
        EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
        EMAILJS_TEMPLATE_ID: ${{ secrets.EMAILJS_TEMPLATE_ID }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL || github.event.inputs.email }}
      run: |
        cat > send-email.js << 'EOF'
        const emailjs = require('@emailjs/nodejs');
        const fs = require('fs');
        
        // EmailJS ì´ˆê¸°í™”
        emailjs.init({
          publicKey: process.env.EMAILJS_PUBLIC_KEY || 'Nt6PrPKpsL1ruZEIH',
        });
        
        // ë²•ë ¹ ë°ì´í„° ë¡œë“œ
        const lawsData = JSON.parse(fs.readFileSync('docs/index.json', 'utf8'));
        
        // ë¶„ê¸° ê²°ì •
        const quarter = '${{ steps.quarter.outputs.quarter }}';
        const quarterMonths = '${{ steps.quarter.outputs.months }}'.split(',').map(Number);
        
        // ë¶„ê¸°ë³„ ë²•ë ¹ í•„í„°ë§
        const quarterLaws = lawsData.filter(law => {
          if (!law.effectiveDate) return false;
          const month = new Date(law.effectiveDate).getMonth() + 1;
          const year = new Date(law.effectiveDate).getFullYear();
          return year === 2025 && quarterMonths.includes(month);
        });
        
        // ì§ë¬´ë³„ ì§‘ê³„
        const jobCategories = {};
        quarterLaws.forEach(law => {
          const category = (law.categories && law.categories[0]) || 'ê¸°íƒ€';
          jobCategories[category] = (jobCategories[category] || 0) + 1;
        });
        
        // ì§ë¬´ë³„ í˜„í™© í…ìŠ¤íŠ¸
        let jobSummary = '';
        Object.entries(jobCategories)
          .sort((a, b) => b[1] - a[1])
          .forEach(([category, count]) => {
            jobSummary += `${category}: ${count}ê±´\n`;
          });
        
        // ìµœê·¼ ë²•ë ¹ 5ê°œ
        const recentLaws = quarterLaws
          .sort((a, b) => new Date(b.effectiveDate) - new Date(a.effectiveDate))
          .slice(0, 5)
          .map(law => `â€¢ ${law.title} (${law.effectiveDate})`)
          .join('\n');
        
        // ì´ë©”ì¼ íŒŒë¼ë¯¸í„°
        const templateParams = {
          email: process.env.RECIPIENT_EMAIL || 'test@example.com',
          name: 'ë‹´ë‹¹ì',
          total: quarterLaws.length.toString(),
          quarter: quarter,
          quarterly: `${quarter}: ${quarterLaws.length}ê±´`,
          job: jobSummary,
          laws: recentLaws,
          title: `[RegRader] 2025ë…„ ${quarter} ë²•ë ¹ ì‹œí–‰ ì˜ˆì • ì•ˆë‚´ - ${quarterLaws.length}ê±´`,
          content: `ì•ˆë…•í•˜ì„¸ìš”,\n\n2025ë…„ ${quarter}ì— ì‹œí–‰ ì˜ˆì •ì¸ ë²•ë ¹ ${quarterLaws.length}ê±´ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n${jobSummary}\n\nì£¼ìš” ê°œì • ë²•ë ¹:\n${recentLaws}\n\nìì„¸í•œ ë‚´ìš©ì€ https://tjdudfhr.github.io/RegRader/ ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`,
          url: 'https://tjdudfhr.github.io/RegRader/',
          date: new Date().toLocaleDateString('ko-KR')
        };
        
        // ì´ë©”ì¼ ë°œì†¡
        emailjs.send(
          process.env.EMAILJS_SERVICE_ID || 'service_7tdd8dh',
          process.env.EMAILJS_TEMPLATE_ID || 'template_tu71wgt',
          templateParams
        ).then(
          (response) => {
            console.log('SUCCESS!', response.status, response.text);
            console.log(`Email sent to ${templateParams.email} for ${quarter}`);
          },
          (error) => {
            console.error('FAILED...', error);
            process.exit(1);
          }
        );
        EOF
        
        node send-email.js
    
    - name: Create Issue for tracking
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          const quarter = '${{ steps.quarter.outputs.quarter }}';
          const date = new Date().toLocaleDateString('ko-KR');
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“§ ${quarter} ë²•ë ¹ í˜„í™© ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ - ${date}`,
            body: `## âœ… ë¶„ê¸°ë³„ ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ\n\n- **ë¶„ê¸°**: ${quarter}\n- **ë°œì†¡ì¼**: ${date}\n- **ë°›ëŠ” ì‚¬ëŒ**: ${{ env.RECIPIENT_EMAIL }}\n- **ìƒíƒœ**: ì„±ê³µ\n\n[ëŒ€ì‹œë³´ë“œ í™•ì¸í•˜ê¸°](https://tjdudfhr.github.io/RegRader/)`,
            labels: ['email-notification', 'automated']
          })