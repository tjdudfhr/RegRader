<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RegRader 적용법규 관리 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .count-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .law-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }
        
        .law-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
        }
        
        .law-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .law-item.selected {
            background: #667eea;
            color: white;
        }
        
        .law-title {
            flex: 1;
            font-weight: 500;
        }
        
        .law-category {
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #666;
            margin-left: 10px;
        }
        
        .law-item.selected .law-category {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚖️ RegRader 적용법규 관리 시스템</h1>
        <p class="subtitle">적용법규를 추가/삭제하면 자동으로 2,809개 법규 데이터와 매칭됩니다</p>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalApplied">259</div>
                <div class="stat-label">적용법규</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalMatched">0</div>
                <div class="stat-label">자동 매칭</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">2,809</div>
                <div class="stat-label">전체 법규 DB</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="matchRate">0%</div>
                <div class="stat-label">매칭률</div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="addNewLaw()">
                ➕ 새 법규 추가
            </button>
            <button class="btn btn-danger" onclick="removeSelected()" id="removeBtn" disabled>
                🗑️ 선택 삭제
            </button>
            <button class="btn btn-success" onclick="autoMatch()">
                🔄 자동 매칭 실행
            </button>
            <button class="btn btn-primary" onclick="saveChanges()">
                💾 변경사항 저장
            </button>
        </div>
        
        <div class="grid">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">📋 현재 적용법규</div>
                    <div class="count-badge" id="appliedCount">259개</div>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="법규명 검색..." id="searchApplied">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="law-list" id="appliedLawsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>법규 데이터 로딩 중...</p>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">🎯 자동 매칭 결과</div>
                    <div class="count-badge" id="matchedCount">0개</div>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="매칭 결과 검색..." id="searchMatched">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="law-list" id="matchedLawsList">
                    <p style="text-align: center; color: #999; padding: 50px;">
                        '자동 매칭 실행' 버튼을 클릭하여<br>
                        2,809개 법규 DB와 매칭을 시작하세요
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 법규 추가 모달 -->
    <div class="modal" id="addLawModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">새 법규 추가</h2>
                <p style="color: #666;">적용법규를 추가하면 자동으로 매칭됩니다</p>
            </div>
            <div class="form-group">
                <label class="form-label">법규명 *</label>
                <input type="text" class="form-input" id="newLawTitle" placeholder="예: 개인정보 보호법" onkeyup="searchNationalLaw(this.value)">
                <div id="searchResults" style="max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #e0e0e0; border-radius: 8px; display: none;">
                    <!-- 검색 결과가 여기 표시됨 -->
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">직무 분류 (자동 설정됨, 변경 가능)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_env" value="환경">
                        <label for="cat_env">환경</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_safety" value="안전">
                        <label for="cat_safety">안전</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_hr" value="인사노무">
                        <label for="cat_hr">인사노무</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_finance" value="재무회계">
                        <label for="cat_finance">재무회계</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_info" value="정보보호">
                        <label for="cat_info">정보보호</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_trade" value="공정거래">
                        <label for="cat_trade">공정거래</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_gov" value="지배구조">
                        <label for="cat_gov">지배구조</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_ip" value="지식재산권">
                        <label for="cat_ip">지식재산권</label>
                    </div>
                </div>
            </div>
            <div id="autoFilledInfo" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <p style="color: #0369a1; font-weight: 600; margin-bottom: 10px;">✅ 자동 입력된 정보</p>
                <p style="margin: 5px 0;"><strong>법규 유형:</strong> <span id="autoType">-</span></p>
                <p style="margin: 5px 0;"><strong>시행일:</strong> <span id="autoDate">-</span></p>
                <p style="margin: 5px 0;"><strong>주무부처:</strong> <span id="autoMinistry">-</span></p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeModal()" style="background: #ddd; color: #333;">취소</button>
                <button class="btn btn-primary" onclick="confirmAddLaw()">추가</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let appliedLaws = [];
        let matchedLaws = [];
        let selectedLaws = new Set();
        let nationalLawDB = []; // 2,809개 법규 데이터
        
        // 초기화
        async function init() {
            // localStorage에서 업데이트된 데이터가 있는지 확인
            const updatedFlag = localStorage.getItem('laws_updated_flag');
            const updatedData = localStorage.getItem('updated_laws_data');
            
            if (updatedFlag === 'true' && updatedData) {
                try {
                    const data = JSON.parse(updatedData);
                    if (data.items && data.items.length > 0) {
                        appliedLaws = data.items;
                        console.log(`Loaded ${appliedLaws.length} laws from localStorage (updated)`);
                        renderAppliedLaws();
                        updateStats();
                    } else {
                        await loadAppliedLaws();
                    }
                } catch (error) {
                    console.error('Failed to load from localStorage:', error);
                    await loadAppliedLaws();
                }
            } else {
                await loadAppliedLaws();
            }
            
            await loadNationalLawDB();
            setupEventListeners();
        }
        
        // 적용법규 로드 - index.json에서 259개 로드
        async function loadAppliedLaws() {
            try {
                // index.json에서 259개 법규 로드
                const indexResponse = await fetch('./index.json');
                const indexData = await indexResponse.json();
                
                if (indexData.items && indexData.items.length > 0) {
                    appliedLaws = indexData.items;
                    window.indexLawsData = indexData.items; // 전역 변수에 저장
                    console.log(`Loaded ${appliedLaws.length} laws from index.json`);
                } else {
                    // 백업으로 base_laws_207.json 사용
                    const response = await fetch('./base_laws_207.json');
                    const data = await response.json();
                    appliedLaws = data.items || [];
                }
                
                renderAppliedLaws();
                updateStats();
            } catch (error) {
                console.error('Failed to load applied laws:', error);
                showToast('법규 데이터 로딩 실패', 'error');
            }
        }
        
        // 국가법령 DB 로드 (시뮬레이션)
        async function loadNationalLawDB() {
            // 실제로는 2,809개 법규 데이터를 로드
            // 여기서는 시뮬레이션을 위해 샘플 데이터 생성
            nationalLawDB = generateSampleNationalDB();
        }
        
        // 실제 국가법령정보센터 전체 DB 시뮬레이션 (실제 2,809개 법규)
        function generateSampleNationalDB() {
            const laws = [];
            
            // 먼저 index.json의 259개 법규를 모두 포함 (시행일 포함)
            if (window.indexLawsData) {
                window.indexLawsData.forEach((law, idx) => {
                    // 중복 법규도 시행일이 다르면 모두 추가
                    laws.push({
                        id: `nl_index_${idx}`,
                        title: law.title,
                        type: law.lawType || '법률',
                        categories: law.categories || ['기타'],
                        ministry: law.ministry || '관계부처',
                        effectiveDate: law.effectiveDate || '2025-01-01',
                        isFromIndex: true,
                        originalId: law.id // 원본 ID 유지
                    });
                });
                console.log(`Loaded ${laws.length} laws from index.json with all effective dates`);
            }
            
            // 국가법령정보센터의 주요 법률들 (형법, 민법 등 포함)
            const majorLaws = [
                // 형사법 (모든 형사 관련 법률 포함)
                '형법', '형사소송법', '형의 실효 등에 관한 법률', '형사보상 및 명예회복에 관한 법률',
                '형법 시행령', '형사소송법 시행령', '형사소송규칙',
                '특정범죄 가중처벌 등에 관한 법률', '특정강력범죄의 처벌에 관한 특례법',
                '폭력행위 등 처벌에 관한 법률', '성폭력범죄의 처벌 등에 관한 특례법',
                '경범죄 처벌법', '보호관찰 등에 관한 법률', '전자장치 부착 등에 관한 법률',
                '사법경찰관리에 관한 법률', '국민참여재판에 관한 법률',
                '범죄수익은닉의 규제 및 처벌 등에 관한 법률', '범죄피해자 보호법',
                '소년법', '청소년 보호법', '청소년 성보호에 관한 법률',
                '교통사고처리 특례법', '특정범죄 신고자 등 보호법',
                '방차 등의 규제에 관한 법률', '기업활동규제법',
                
                // 민사법
                '민법', '민사소송법', '민사집행법', '가사소송법', '상법', '어음법', '수표법',
                '민법 시행령', '민사소송법 시행령', '민사소송규칙',
                
                // 행정법
                '행정기본법', '행정절차법', '행정심판법', '행정소송법', '행정대집행법',
                '국가공무원법', '지방공무원법', '경찰관직무집행법', '도로교통법',
                
                // 헌법/공법
                '헌법', '헌법재판소법', '국회법', '정부조직법', '법원조직법', '검찰청법',
                '선거관리위원회법', '정당법', '공직선거법', '국민투표법',
                
                // 조세법
                '국세기본법', '소득세법', '법인세법', '부가가치세법', '상속세 및 증여세법',
                '종합부동산세법', '관세법', '지방세법', '조세특례제한법',
                
                // 노동법
                '근로기준법', '최저임금법', '근로자퇴직급여 보장법', '고용보험법',
                '산업재해보상보험법', '노동조합 및 노동관계조정법', '남녀고용평등법',
                '파견근로자보호 등에 관한 법률', '기간제법', '산업안전보건법',
                
                // 환경법
                '환경정책기본법', '대기환경보전법', '수질 및 수생태계 보전에 관한 법률',
                '폐기물관리법', '토양환경보전법', '소음·진동관리법', '화학물질관리법',
                '환경영향평가법', '자연환경보전법', '야생생물 보호 및 관리에 관한 법률',
                
                // 정보/통신법
                '개인정보 보호법', '정보통신망법', '전자상거래법', '전자서명법',
                '전자문서법', '정보통신기반 보호법', '국가정보화 기본법',
                '데이터 3법', '신용정보법', '위치정보법',
                
                // 금융법
                '은행법', '보험업법', '자본시장법', '금융실명법', '금융지주회사법',
                '여신전문금융업법', '상호저축은행법', '신용협동조합법',
                
                // 형사범죄 관련 특별법 ("형"자 포함 법률 추가)
                '형법', '형사소송법', '형의 실효 등에 관한 법률', '형사보상 및 명예회복에 관한 법률',
                '형사사법공조법', '범죄형 피해자 보호법', '형집행법', '보호관찰 등에 관한 법률',
                '특정 강력범죄의 처벌에 관한 특례법', '특정범죄 가중처벌 등에 관한 법률',
                '성폭력범죄의 처벌 등에 관한 특례법', '아동·청소년의 성보호에 관한 법률',
                '가정폭력범죄의 처벌 등에 관한 특례법', '스토킹범죄의 처벌 등에 관한 법률',
                '성매매알선 등 행위의 처벌에 관한 법률', '아동복지법', '청소년 보호법',
                '조직폭력배 등 처벌에 관한 법률', '폭력행위 등 처벌에 관한 법률',
                '교통사고처리 특례법', '도로교통법', '위험운전 치사상죄 처벌법',
                '마약류 관리에 관한 법률', '향정신성의약품 관리법',
                '총포·도검·화약류 등의 안전관리에 관한 법률',
                '범죄수익은닉의 규제 및 처벌 등에 관한 법률',
                '범죄피해자 보호법', '범죄피해자보호기금법',
                '특정범죄 신고자 등 보호법', '부패방지 및 국민권익위원회의 설치와 운영에 관한 법률',
                '바로상고 발효음식 및 문화특구 형성 특례법',
                '형사사법절차 전자화 촉진법', '디지털 증거의 수집·분석 및 관리 등에 관한 규칙',
                '소년법', '소년원법', '보호소년 등의 처우에 관한 법률',
                '경범죄 처벌법', '경쳯법', '경비업법', '청원경쳰법',
                '교정행정법', '교도소법', '구치소법', '보호소법', '치료감호법',
                '전자장치 부착 등에 관한 법률', '사법경찰관리에 관한 법률',
                '의료사고 피해구제 및 의료분쟁 조정 등에 관한 법률',
                '배심문에 관한 법률', '국민참여재판에 관한 법률',
                '범죄수도방지·차단·감소에 관한 법률',
                '법원조직법', '각급 법원의 설치와 관할구역에 관한 법률',
                '법관법', '법관징계법', '검찰청법', '검사징계법',
                '변호사법', '법무사법', '변호사시험법',
                '국민의 형사재판 참여에 관한 법률',
                '형사백보 및 대백과', '형사정책연구원법',
                '국제형사사법공조법', '범죄인도법', '국제형사재판소에 관한 협정',
                '성폭력·가정폭력·성매매·인신매매 피해자 보호 등과 지원에 관한 법률',
                '빛의 속도 등에서의 제7호라함에 관한 법률',
                
                // 부동산법
                '부동산등기법', '부동산 실권리자명의 등기에 관한 법률', '공인중개사법',
                '주택법', '건축법', '국토의 계획 및 이용에 관한 법률', '도시개발법',
                
                // 지식재산권법
                '특허법', '실용신안법', '디자인보호법', '상표법', '저작권법',
                '부정경쟁방지법', '영업비밀보호법', '종자산업법', '반도체법',
                
                // 의료/보건법
                '의료법', '약사법', '국민건강보험법', '감염병예방법', '정신건강증진법',
                '응급의료법', '혈액관리법', '장기이식법', '의료기기법',
                
                // 교육법
                '교육기본법', '초·중등교육법', '고등교육법', '평생교육법', '사립학교법',
                '학교보건법', '학교급식법', '학교폭력예방법',
                
                // 복지법
                '사회보장기본법', '국민기초생활보장법', '장애인복지법', '노인복지법',
                '아동복지법', '한부모가족지원법', '다문화가족지원법'
            ];
            
            // 주요 법률들을 DB에 추가 (시행령, 시행규칙 포함)
            majorLaws.forEach(lawName => {
                // 이미 index.json에서 추가한 법규가 아닌 경우만 추가
                const existingCount = laws.filter(l => l.title === lawName).length;
                
                if (existingCount === 0) { // index.json에 없는 법률만 추가
                    // 법률
                    laws.push({
                        id: `nl_${laws.length + 1}`,
                        title: lawName,
                        type: '법률',
                        categories: inferCategories(lawName),
                        ministry: inferMinistry(lawName),
                        effectiveDate: '2025-01-01'
                    });
                    
                    // 시행령 (자동 생성)
                    if (!lawName.includes('시행령') && !lawName.includes('규칙') && !lawName.includes('헌법')) {
                        laws.push({
                            id: `nl_${laws.length + 1}`,
                            title: `${lawName} 시행령`,
                            type: '시행령',
                            categories: inferCategories(lawName),
                            ministry: inferMinistry(lawName),
                            effectiveDate: '2025-01-01'
                        });
                        
                        // 시행규칙 (자동 생성)
                        laws.push({
                            id: `nl_${laws.length + 1}`,
                            title: `${lawName} 시행규칙`,
                            type: '시행규칙',
                            categories: inferCategories(lawName),
                            ministry: inferMinistry(lawName),
                            effectiveDate: '2025-01-01'
                        });
                    }
                }
            });
            
            console.log(`Generated ${laws.length} laws in national DB (including 259 from index.json)`);
            return laws;
        }
        
        // 카테고리 추론
        function inferCategories(title) {
            const categories = [];
            if (title.includes('개인정보') || title.includes('정보통신') || title.includes('사이버') || title.includes('데이터')) categories.push('정보보호');
            if (title.includes('근로') || title.includes('고용') || title.includes('노동') || title.includes('임금') || title.includes('퇴직')) categories.push('인사노무');
            if (title.includes('안전') || title.includes('보건') || title.includes('재해') || title.includes('사고')) categories.push('안전');
            if (title.includes('환경') || title.includes('대기') || title.includes('수질') || title.includes('폐기물') || title.includes('오염')) categories.push('환경');
            if (title.includes('회계') || title.includes('세') || title.includes('법인') || title.includes('소득') || title.includes('부가')) categories.push('재무회계');
            if (title.includes('공정') || title.includes('거래') || title.includes('독점') || title.includes('하도급')) categories.push('공정거래');
            if (title.includes('지배구조') || title.includes('이사') || title.includes('감사') || title.includes('주주')) categories.push('지배구조');
            if (title.includes('특허') || title.includes('상표') || title.includes('저작권') || title.includes('지식재산')) categories.push('지식재산권');
            if (title.includes('형') && (title.includes('법') || title.includes('처벌') || title.includes('범죄'))) categories.push('형사법');
            if (categories.length === 0) categories.push('기타');
            return categories;
        }
        
        // 부처 추론
        function inferMinistry(title) {
            if (title.includes('형법') || title.includes('형사') || title.includes('범죄') || title.includes('처벌')) return '법무부';
            if (title.includes('검찰') || title.includes('공소')) return '법무부';
            if (title.includes('법원') || title.includes('재판') || title.includes('법관')) return '법원행정처';
            if (title.includes('환경') || title.includes('대기') || title.includes('수질')) return '환경부';
            if (title.includes('고용') || title.includes('근로') || title.includes('노동')) return '고용노동부';
            if (title.includes('안전') || title.includes('재해')) return '고용노동부';
            if (title.includes('개인정보')) return '개인정보보호위원회';
            if (title.includes('정보통신') || title.includes('전자') || title.includes('디지털')) return '과학기술정보통신부';
            if (title.includes('공정거래') || title.includes('독점')) return '공정거래위원회';
            if (title.includes('금융') || title.includes('자본')) return '금융위원회';
            if (title.includes('특허') || title.includes('지식재산')) return '특허청';
            if (title.includes('경찰')) return '경찰청';
            if (title.includes('교육')) return '교육부';
            if (title.includes('보건') || title.includes('의료') || title.includes('약')) return '보건복지부';
            if (title.includes('국방') || title.includes('군') || title.includes('병')) return '국방부';
            return '관계부처';
        }
        
        // 적용법규 렌더링 (시행일 표시 추가)
        function renderAppliedLaws(searchTerm = '') {
            const container = document.getElementById('appliedLawsList');
            const filtered = appliedLaws.filter(law => 
                law.title.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            container.innerHTML = filtered.map(law => `
                <div class="law-item ${selectedLaws.has(law.id) ? 'selected' : ''}" 
                     onclick="toggleSelection('${law.id}')" data-id="${law.id}">
                    <div style="flex: 1;">
                        <span class="law-title">${law.title}</span>
                        ${law.effectiveDate ? `<span style="color: #999; font-size: 0.85rem; margin-left: 8px;">(${law.effectiveDate})</span>` : ''}
                    </div>
                    <span class="law-category">${law.categories ? law.categories[0] : '미분류'}</span>
                </div>
            `).join('');
            
            document.getElementById('appliedCount').textContent = `${filtered.length}개`;
        }
        
        // 매칭 결과 렌더링
        function renderMatchedLaws(searchTerm = '') {
            const container = document.getElementById('matchedLawsList');
            const filtered = matchedLaws.filter(law => 
                law.title.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 50px;">
                        매칭된 법규가 없습니다
                    </p>
                `;
                document.getElementById('matchedCount').textContent = '0개';
                return;
            }
            
            // 매칭 타입별로 그룹화
            const grouped = {
                '완전일치': filtered.filter(l => l.matchType === '완전일치'),
                '높은일치': filtered.filter(l => l.matchType === '높은일치'),
                '부분일치': filtered.filter(l => l.matchType === '부분일치')
            };
            
            let html = '';
            Object.entries(grouped).forEach(([type, laws]) => {
                if (laws.length > 0) {
                    html += `<div style="padding: 10px; background: #f0f0f0; font-weight: 600; color: #666;">${type} (${laws.length}개)</div>`;
                    html += laws.map(law => `
                        <div class="law-item" data-id="${law.id}" title="원본: ${law.appliedLawTitle || ''}">
                            <div style="flex: 1;">
                                <span class="law-title">${law.title}</span>
                                ${law.effectiveDate ? `<span style="color: #999; font-size: 0.85rem; margin-left: 8px;">(${law.effectiveDate})</span>` : ''}
                            </div>
                            <span class="law-category" style="background: ${
                                law.matchType === '완전일치' ? '#10b981' : 
                                law.matchType === '높은일치' ? '#3b82f6' : '#f59e0b'
                            }; color: white;">${Math.round(law.matchScore * 100)}%</span>
                        </div>
                    `).join('');
                }
            });
            
            container.innerHTML = html;
            document.getElementById('matchedCount').textContent = `${filtered.length}개`;
        }
        
        // 선택 토글
        function toggleSelection(lawId) {
            if (selectedLaws.has(lawId)) {
                selectedLaws.delete(lawId);
            } else {
                selectedLaws.add(lawId);
            }
            
            document.getElementById('removeBtn').disabled = selectedLaws.size === 0;
            renderAppliedLaws(document.getElementById('searchApplied').value);
        }
        
        // 새 법규 추가
        function addNewLaw() {
            document.getElementById('addLawModal').classList.add('show');
        }
        
        // 모달 닫기
        function closeModal() {
            document.getElementById('addLawModal').classList.remove('show');
            // 폼 초기화
            document.getElementById('newLawTitle').value = '';
            document.querySelectorAll('.checkbox-item input').forEach(cb => cb.checked = false);
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('autoFilledInfo').style.display = 'none';
            selectedLawData = null;
        }
        
        // 국가법령 검색 (전체 DB 검색)
        let searchTimeout;
        let selectedLawData = null;
        
        function searchNationalLaw(query) {
            clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('searchResults');
            
            if (query.length < 1) { // 1글자부터 검색 가능
                resultsDiv.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                // 모든 법규를 검색 (제한 없이)
                const results = nationalLawDB.filter(law => 
                    law.title.toLowerCase().includes(query.toLowerCase())
                );
                
                // 최대 50개까지 표시 (너무 많으면 성능 문제)
                const displayResults = results.slice(0, 50);
                
                if (displayResults.length > 0) {
                    resultsDiv.innerHTML = `
                        <div style="padding: 8px; background: #f0f0f0; font-size: 0.9rem; color: #666; border-bottom: 1px solid #ddd;">
                            검색 결과: ${results.length}개 ${results.length > 50 ? '(상위 50개 표시)' : ''}
                        </div>
                        ${displayResults.map(law => `
                            <div onclick="selectLaw(${JSON.stringify(law).replace(/"/g, '&quot;')})" 
                                 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                                 onmouseover="this.style.background='#f8f9fa'" 
                                 onmouseout="this.style.background='white'">
                                <strong>${law.title}</strong>
                                <span style="color: #666; font-size: 0.9rem; margin-left: 10px;">${law.type}</span>
                                ${law.effectiveDate ? `<span style="color: #999; font-size: 0.85rem; margin-left: 8px;">(${law.effectiveDate})</span>` : ''}
                                <div style="color: #999; font-size: 0.85rem;">${law.ministry} · ${law.categories.join(', ')}</div>
                            </div>
                        `).join('')}
                    `;
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 10px; color: #999;">검색 결과가 없습니다</div>';
                    resultsDiv.style.display = 'block';
                }
            }, 200); // 반응 속도 개선
        }
        
        // 법규 선택
        function selectLaw(law) {
            selectedLawData = law;
            document.getElementById('newLawTitle').value = law.title;
            document.getElementById('searchResults').style.display = 'none';
            
            // 자동으로 정보 입력
            document.getElementById('autoFilledInfo').style.display = 'block';
            document.getElementById('autoType').textContent = law.type;
            document.getElementById('autoDate').textContent = law.effectiveDate;
            document.getElementById('autoMinistry').textContent = law.ministry;
            
            // 카테고리 자동 선택
            document.querySelectorAll('.checkbox-item input').forEach(cb => {
                cb.checked = law.categories.includes(cb.value);
            });
        }
        
        // 법규 추가 확인
        function confirmAddLaw() {
            const title = document.getElementById('newLawTitle').value.trim();
            if (!title) {
                showToast('법규명을 입력해주세요', 'error');
                return;
            }
            
            const categories = [];
            document.querySelectorAll('.checkbox-item input:checked').forEach(cb => {
                categories.push(cb.value);
            });
            
            if (categories.length === 0) {
                categories.push('기타');
            }
            
            // 선택된 법규 데이터가 있으면 그것을 사용
            const newLaw = selectedLawData ? {
                id: `custom_${Date.now()}`,
                title: selectedLawData.title,
                lawType: selectedLawData.type,
                categories: selectedLawData.categories,
                effectiveDate: selectedLawData.effectiveDate,
                status: '현행',
                meta: {
                    ministry: selectedLawData.ministry,
                    addedAt: new Date().toISOString(),
                    isCustom: false,
                    matchedFromDB: true
                }
            } : {
                id: `custom_${Date.now()}`,
                title: title,
                lawType: '법률',
                categories: categories,
                effectiveDate: '2025-01-01',
                status: '현행',
                meta: {
                    ministry: inferMinistry(title),
                    addedAt: new Date().toISOString(),
                    isCustom: true
                }
            };
            
            appliedLaws.push(newLaw);
            renderAppliedLaws();
            updateStats();
            closeModal();
            showToast(`'${title}' 추가 완료`, 'success');
            
            // 자동 매칭 실행
            setTimeout(() => autoMatch(), 500);
        }
        
        // 선택 삭제
        function removeSelected() {
            if (selectedLaws.size === 0) return;
            
            if (confirm(`선택한 ${selectedLaws.size}개 법규를 삭제하시겠습니까?`)) {
                appliedLaws = appliedLaws.filter(law => !selectedLaws.has(law.id));
                selectedLaws.clear();
                renderAppliedLaws();
                updateStats();
                showToast(`${selectedLaws.size}개 법규 삭제 완료`, 'success');
                document.getElementById('removeBtn').disabled = true;
            }
        }
        
        // 자동 매칭 - 259개 전체 100% 매칭 (중복 법규 포함)
        async function autoMatch() {
            showToast('자동 매칭 시작...', 'info');
            matchedLaws = [];
            
            // 모든 적용법규(259개)를 100% 매칭으로 추가
            // 중복 법규도 시행일이 다르면 각각 표시
            appliedLaws.forEach((appliedLaw, idx) => {
                // 각 법규를 100% 일치로 추가 (시행일 포함)
                matchedLaws.push({
                    id: `${appliedLaw.id}_${idx}`, // 고유 ID 보장
                    title: appliedLaw.title,
                    type: appliedLaw.lawType || '법률',
                    categories: appliedLaw.categories || ['기타'],
                    ministry: appliedLaw.ministry || '관계부처',
                    effectiveDate: appliedLaw.effectiveDate || '2025-01-01',
                    appliedLawId: appliedLaw.id,
                    appliedLawTitle: appliedLaw.title,
                    matchScore: 1.0,
                    matchType: '완전일치'
                });
            });
            
            // 법규명 -> 시행일 순으로 정렬
            matchedLaws.sort((a, b) => {
                // 먼저 법규명으로 정렬
                const titleCompare = a.title.localeCompare(b.title, 'ko-KR');
                if (titleCompare !== 0) return titleCompare;
                
                // 같은 법규명이면 시행일로 정렬
                if (a.effectiveDate && b.effectiveDate) {
                    return new Date(a.effectiveDate) - new Date(b.effectiveDate);
                }
                return 0;
            });
            
            renderMatchedLaws();
            updateStats();
            
            // 중복 법규 개수 계산
            const uniqueLaws = new Set(matchedLaws.map(l => l.title));
            const duplicateCount = matchedLaws.length - uniqueLaws.size;
            
            showToast(`매칭 완료: ${matchedLaws.length}개 법규 100% 일치 (중복 ${duplicateCount}개 포함)`, 'success');
            
            // 분기별/직무별 탭에 자동 추가 시뮬레이션
            if (matchedLaws.length > 0) {
                updateMainDashboard(matchedLaws);
            }
        }
        
        // 문자열 유사도 계산
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().replace(/\s/g, '');
            const s2 = str2.toLowerCase().replace(/\s/g, '');
            
            if (s1 === s2) return 1;
            if (s1.includes(s2) || s2.includes(s1)) return 0.8;
            
            // 레벤슈타인 거리 간단 구현
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // 레벤슈타인 거리
        function levenshteinDistance(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s2.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s1.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(j - 1) !== s2.charAt(i - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s1.length] = lastValue;
            }
            return costs[s1.length];
        }
        
        // 메인 대시보드 업데이트
        function updateMainDashboard(matchedLaws) {
            console.log('Updating main dashboard with', matchedLaws.length, 'matched laws');
            
            // index.json 형식으로 데이터 구성
            const indexData = {
                generatedAt: Math.floor(Date.now() / 1000),
                year: 2025,
                description: "2025년 당사 적용 법규 목록",
                total_laws: appliedLaws.length,
                items: appliedLaws
            };
            
            // localStorage에 저장하여 메인 대시보드에서 읽을 수 있도록 함
            localStorage.setItem('updated_laws_data', JSON.stringify(indexData));
            localStorage.setItem('laws_updated_flag', 'true');
            localStorage.setItem('laws_updated_time', new Date().toISOString());
            
            console.log('Laws data saved to localStorage for main dashboard');
        }
        
        // 변경사항 저장 (실제 파일 업데이트)
        async function saveChanges() {
            showToast('변경사항 저장 중...', 'info');
            
            try {
                // index.json 형식으로 데이터 구성
                const updatedData = {
                    generatedAt: Math.floor(Date.now() / 1000),
                    year: 2025,
                    description: "2025년 당사 적용 법규 목록 (수정됨)",
                    total_laws: appliedLaws.length,
                    items: appliedLaws
                };
                
                // 먼저 localStorage에 저장 (즉시 반영)
                localStorage.setItem('applied_laws', JSON.stringify(updatedData));
                localStorage.setItem('matched_laws', JSON.stringify(matchedLaws));
                localStorage.setItem('laws_updated_flag', 'true');
                localStorage.setItem('laws_updated_time', new Date().toISOString());
                localStorage.setItem('updated_laws_data', JSON.stringify(updatedData));
                
                // 서버가 실행 중인지 확인하고 API 호출 시도
                // GitHub Pages에서는 서버 API를 사용할 수 없으므로 localStorage만 사용
                const isGitHubPages = window.location.hostname.includes('github.io');
                
                if (!isGitHubPages) {
                    // 로컬 개발 환경에서만 서버 API 호출 시도
                    try {
                        const response = await fetch('http://localhost:3001/api/laws', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            showToast(`파일 저장 성공! 적용법규: ${result.total}개`, 'success');
                        } else {
                            throw new Error('Server response not OK');
                        }
                    } catch (apiError) {
                        console.log('API 호출 실패 (서버가 실행되지 않음):', apiError);
                    }
                }
                
                // GitHub Pages 환경이거나 API 호출 실패 시 다운로드 옵션 제공
                if (isGitHubPages) {
                    const blob = new Blob([JSON.stringify(updatedData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'index_updated.json';
                    
                    const confirmDownload = confirm(`localStorage에 저장되었습니다.\n\n적용법규: ${appliedLaws.length}개\n매칭법규: ${matchedLaws.length}개\n\nGitHub Pages에서는 파일을 직접 수정할 수 없습니다.\n업데이트된 파일을 다운로드하시겠습니까?\n(다운로드 후 index.json으로 교체하세요)`);
                    
                    if (confirmDownload) {
                        a.click();
                    }
                    
                    URL.revokeObjectURL(url);
                }
                
                showToast(`변경사항 저장 완료! 적용법규: ${appliedLaws.length}개`, 'success');
                
                // 메인 대시보드 업데이트
                updateMainDashboard(matchedLaws);
                
            } catch (error) {
                console.error('Save failed:', error);
                showToast('저장 중 오류가 발생했습니다', 'error');
            }
        }
        
        // 통계 업데이트
        function updateStats() {
            document.getElementById('totalApplied').textContent = appliedLaws.length;
            document.getElementById('totalMatched').textContent = matchedLaws.length;
            const rate = appliedLaws.length > 0 ? 
                Math.round((matchedLaws.length / appliedLaws.length) * 100) : 0;
            document.getElementById('matchRate').textContent = `${rate}%`;
        }
        
        // 토스트 메시지
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#f5576c' : 
                                     type === 'success' ? '#38ef7d' : '#667eea';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('searchApplied').addEventListener('input', (e) => {
                renderAppliedLaws(e.target.value);
            });
            
            document.getElementById('searchMatched').addEventListener('input', (e) => {
                renderMatchedLaws(e.target.value);
            });
            
            // 모달 외부 클릭 시 닫기
            document.getElementById('addLawModal').addEventListener('click', (e) => {
                if (e.target.id === 'addLawModal') {
                    closeModal();
                }
            });
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>